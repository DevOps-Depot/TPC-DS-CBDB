-- start query 16 in stream 2 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
     (SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '81137','90054','55601','52713','13149','23993',
                          '64871','94307','28810','85662','24227',
                          '32755','37008','38428','67205','53387',
                          '40791','59057','63047','15783','73355',
                          '93261','45263','38626','80922','27616',
                          '24643','61143','37328','22826','31021',
                          '94898','68292','19452','95359','80990',
                          '50347','33806','34102','20449','27650',
                          '62997','64031','76072','52559','30135',
                          '43344','30936','22229','17049','44925',
                          '88239','41938','53052','57763','94536',
                          '98871','28853','97130','45772','82510',
                          '25419','21698','63500','56856','46917',
                          '17650','79355','83851','17826','95122',
                          '96455','38533','57021','52939','49372',
                          '36608','56928','71819','45324','85657',
                          '18137','40089','79482','68676','63319',
                          '76777','20775','53980','48321','98731',
                          '96901','41119','73020','23671','59454',
                          '64797','83156','46011','44220','72295',
                          '32708','92363','87582','27655','64778',
                          '10793','66398','37398','74545','75097',
                          '90875','29610','10783','74181','74032',
                          '45804','24202','31597','61775','21350',
                          '40703','86978','88433','56079','83148',
                          '63666','18981','42002','75127','61011',
                          '59377','46995','25799','31792','16985',
                          '17544','53647','99558','64939','61271',
                          '97321','37236','21813','33893','48747',
                          '12868','83700','93349','39382','32484',
                          '54386','49266','51798','23541','25929',
                          '36360','76409','28219','50388','55842',
                          '18816','50296','52144','51995','33863',
                          '48474','51994','88940','89111','54340',
                          '44348','91709','44085','99353','37465',
                          '27484','68365','39730','11082','28227',
                          '55587','73573','56657','11101','61293',
                          '96457','19233','28788','14010','91738',
                          '94134','43676','68509','92847','52968',
                          '38672','36357','31600','49255','76223',
                          '39377','28572','75924','64531','50695',
                          '20312','38351','14504','89967','40824',
                          '13904','47354','95290','56637','87721',
                          '42804','83173','15306','88575','39650',
                          '33264','17967','10713','71694','33541',
                          '18250','95933','78465','95215','32514',
                          '77470','31159','76351','56904','22575',
                          '85049','89750','23288','18555','79091',
                          '31116','54498','57136','35458','16147',
                          '47252','10794','93490','82057','85250',
                          '60606','25521','32064','40012','57348',
                          '84632','14264','17000','24376','47683',
                          '43098','96687','98327','14786','67712',
                          '54914','53354','86729','23183','84129',
                          '13690','87980','43488','29133','30637',
                          '46257','21272','46631','87790','22185',
                          '55378','10330','51810','56966','59038',
                          '71247','50580','57442','72808','48176',
                          '44851','83290','21247','91309','94291',
                          '74144','59870','24007','54704','79740',
                          '22959','49691','10636','14993','90296',
                          '69217','96855','80480','12164','26153',
                          '79900','58720','39660','70399','70346',
                          '29252','20599','91126','68675','94462',
                          '24639','47015','22930','18946','53110',
                          '53271','37508','37826','14043','29544',
                          '84617','13314','22672','78420','87982',
                          '33818','56775','16632','45451','50126',
                          '92555','94120','84393','43937','72230',
                          '68152','10209','33713','15940','25034',
                          '21115','38748','84886','36231','79610',
                          '13574','72294','58328','57731','38018',
                          '24627','63394','45731','94507','99854',
                          '42086','25947','11732','46962','74229',
                          '94012','81161','52537','83779','93208',
                          '20438','60472','73826','14334','23209',
                          '66175','89532','26676','69806','60972',
                          '99511','13238','54886','15929','76707',
                          '67348','49604','86111','91029','60861',
                          '99135','76839','24310','72733'))
     intersect
     (select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1))A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 16 in stream 2 using template query8.tpl
