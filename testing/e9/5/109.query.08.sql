-- start query 9 in stream 4 using template query8.tpl
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
     (SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '95351','14128','23536','19952','75273','28447',
                          '74091','56189','73086','97433','52130',
                          '16263','98131','17116','57573','47572',
                          '94036','56791','13750','97270','69477',
                          '23968','60181','48262','81804','51521',
                          '24651','88018','74564','14426','86899',
                          '74212','17189','51045','96827','86108',
                          '29126','38743','43805','54218','15383',
                          '94993','54155','35293','33214','31657',
                          '82892','17356','89552','66573','77459',
                          '20620','46167','85638','41296','87110',
                          '52524','57153','21015','75176','25376',
                          '65061','27826','35111','99718','61350',
                          '97940','86250','84430','30840','32532',
                          '84511','27056','76938','22189','78549',
                          '41889','17168','19252','32040','29235',
                          '89948','25249','49395','20925','10158',
                          '83210','49224','26351','39543','23405',
                          '81593','92196','62309','54642','59823',
                          '82402','50755','53387','15704','89963',
                          '96473','38329','53838','89768','37982',
                          '93944','29581','10825','30065','94442',
                          '55518','59338','12136','25972','82144',
                          '39277','65294','33877','33888','21577',
                          '21615','94574','86094','62993','63121',
                          '70663','25732','37137','79569','81490',
                          '29541','92234','81550','36149','97040',
                          '41972','37078','10207','59168','70464',
                          '51338','75474','62698','51657','66579',
                          '18719','66465','20260','49745','74365',
                          '65146','87650','85314','90400','34509',
                          '60107','35376','40266','54429','97882',
                          '56180','65634','33341','59542','75058',
                          '40595','41376','66151','81164','87171',
                          '64246','68316','64121','69399','37634',
                          '43347','64645','31316','22769','21461',
                          '77957','42776','53582','30666','65109',
                          '91792','40675','60453','68715','22720',
                          '87256','73472','76447','97653','79691',
                          '99214','26732','57395','83996','68086',
                          '13864','85427','29726','53005','86806',
                          '14098','39454','67954','38158','34158',
                          '56936','85401','16211','58210','75268',
                          '94107','84481','18157','49305','78454',
                          '53032','81076','18075','15068','62554',
                          '19973','11853','70909','50083','96945',
                          '78235','23748','98884','77986','23230',
                          '38705','12580','58582','63051','81631',
                          '60801','63092','75160','83572','67097',
                          '13691','84550','10793','49244','37664',
                          '24187','59275','44337','85150','44100',
                          '78806','82795','21108','11091','33607',
                          '64544','67974','41410','73757','71980',
                          '89039','92148','16061','63637','24052',
                          '86092','99876','26125','29655','25379',
                          '25046','48216','69881','36761','31222',
                          '27798','34539','70905','45360','16857',
                          '16741','93507','90483','70544','90433',
                          '87322','97420','83408','76902','62655',
                          '66052','97082','56241','58762','56067',
                          '96745','58722','79621','80938','27098',
                          '19012','81266','52376','94617','56599',
                          '29327','34955','12034','88486','81745',
                          '50575','43266','97157','80257','36118',
                          '73629','44006','89966','41579','19334',
                          '14303','35491','26176','13807','86981',
                          '83253','34396','80298','14955','94065',
                          '45455','38494','49642','40584','74131',
                          '12480','97895','43356','32380','81081',
                          '86344','35382','49552','83507','95864',
                          '86861','95516','34169','60650','93964',
                          '16047','68043','24725','50843','28875',
                          '57987','36585','26129','76726','27235',
                          '48224','72683','13216','42832','52721',
                          '78406','98435','31232','56335','57442',
                          '37255','68582','82107','10045','87221',
                          '32707','42546','72178','75795','23214',
                          '92233','71422','50317','79699','59784',
                          '81462','98245','37354','29955','28198',
                          '12668','80040','50455','65806'))
     intersect
     (select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1))A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

-- end query 9 in stream 4 using template query8.tpl
